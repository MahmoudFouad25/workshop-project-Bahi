<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2d3748;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            padding: 20px;
            border-radius: 15px;
            border-right: 4px solid #667eea;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #4a5568;
            font-weight: 600;
        }

        .action-section {
            background: white;
            border-radius: 20px;
            padding: 30px 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            color: #2d3748;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
        }

        .generated-link {
            background: #e0f2fe;
            border: 2px solid #0284c7;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }

        .link-header {
            font-size: 16px;
            font-weight: 700;
            color: #075985;
            margin-bottom: 10px;
        }

        .link-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #0c4a6e;
            word-break: break-all;
            margin-bottom: 10px;
        }

        .offices-grid {
            display: grid;
            gap: 20px;
        }

        .office-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .office-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .office-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .office-name {
            font-size: 20px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .office-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-complete {
            background: #d1fae5;
            color: #065f46;
        }

        .status-incomplete {
            background: #fef3c7;
            color: #92400e;
        }

        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .office-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            color: #4a5568;
        }

        .progress-section {
            margin-bottom: 15px;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .progress-label {
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
        }

        .progress-percentage {
            font-size: 14px;
            font-weight: 700;
            color: #667eea;
        }

        .progress-bar-bg {
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .office-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 40px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .modal-title {
            font-size: 28px;
            color: #2d3748;
            font-weight: 700;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border: none;
            background: #f7fafc;
            color: #4a5568;
            border-radius: 10px;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: #e2e8f0;
        }

        .answer-section {
            margin-bottom: 30px;
        }

        .answer-axis-title {
            font-size: 20px;
            color: #2d3748;
            font-weight: 700;
            margin-bottom: 15px;
            padding: 12px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 10px;
        }

        .answer-section-group {
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }

        .answer-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .answer-item {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .answer-question {
            font-size: 14px;
            color: #4a5568;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .answer-value {
            font-size: 15px;
            color: #667eea;
            font-weight: 600;
        }

        .answer-followup {
            margin-top: 10px;
            padding: 10px;
            background: #fffbeb;
            border: 1px solid #fbbf24;
            border-radius: 8px;
        }

        .followup-label {
            display: block;
            font-size: 12px;
            color: #92400e;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .followup-value {
            font-size: 14px;
            color: #78350f;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .empty-text {
            font-size: 18px;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #4a5568;
            font-weight: 600;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .copy-btn {
            background: #10b981;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.4);
            font-weight: 600;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        @media (max-width: 768px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }

            .office-meta {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-top">
                <h1 class="page-title">ğŸ¢ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨</h1>
                <a href="index.html" class="btn btn-secondary">
                    â†©ï¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </a>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalOffices">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙƒØ§ØªØ¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedOffices">0</div>
                    <div class="stat-label">Ù…ÙƒØ§ØªØ¨ Ø£ÙƒÙ…Ù„Øª Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="incompleteOffices">0</div>
                    <div class="stat-label">Ù…ÙƒØ§ØªØ¨ Ù„Ù… ØªÙƒÙ…Ù„</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="avgProgress">0%</div>
                    <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚Ø¯Ù…</div>
                </div>
            </div>
        </div>

        <!-- Create Link Section -->
        <div class="action-section">
            <h2 class="section-title">ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯</h2>
            
            <div class="form-group">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨</label>
                <input type="text" id="officeNameInput" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ù…ÙƒØªØ¨ ØµÙ†Ø§Ø¹ Ø§Ù„Ø­ÙŠØ§Ø© - Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©">
            </div>

            <div class="form-group">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="participantNameInput" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯">
            </div>

            <button class="btn btn-primary" onclick="generateLink()">
                âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·
            </button>

            <div id="generatedLink" class="generated-link">
                <div class="link-header">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!</div>
                <div class="link-box" id="linkText"></div>
                <button class="copy-btn" onclick="copyLink()">ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
        </div>

        <!-- Offices List Section -->
        <div class="action-section">
            <h2 class="section-title">ğŸ“Š Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨</h2>

            <div class="filter-section">
                <button class="filter-btn active" data-filter="all" onclick="filterOffices('all')">
                    Ø§Ù„ÙƒÙ„
                </button>
                <button class="filter-btn" data-filter="complete" onclick="filterOffices('complete')">
                    Ù…ÙƒØªÙ…Ù„
                </button>
                <button class="filter-btn" data-filter="incomplete" onclick="filterOffices('incomplete')">
                    ØºÙŠØ± Ù…ÙƒØªÙ…Ù„
                </button>
                <button class="filter-btn" data-filter="new" onclick="filterOffices('new')">
                    Ø¬Ø¯ÙŠØ¯
                </button>
            </div>

            <div id="officesContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Office Details -->
    <div id="officeModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalOfficeName">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDZvB9jIzd5ponaiudD61PiL8tfajEHx2A",
            authDomain: "life-makers-diagnostic.firebaseapp.com",
            projectId: "life-makers-diagnostic",
            storageBucket: "life-makers-diagnostic.firebasestorage.app",
            messagingSenderId: "819336926740",
            appId: "1:819336926740:web:d338b3299e6d18e3b67901",
            measurementId: "G-4Z1FWWKG1C"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let allOffices = [];
        let currentFilter = 'all';

        // Generate Link
        window.generateLink = function() {
            const officeName = document.getElementById('officeNameInput').value.trim();
            const participantName = document.getElementById('participantNameInput').value.trim();

            if (!officeName) {
                alert('âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨');
                return;
            }

            const baseUrl = window.location.origin + window.location.pathname.replace('admin-offices.html', 'questions-offices.html');
            let link = `${baseUrl}?office=${encodeURIComponent(officeName)}`;
            
            if (participantName) {
                link += `&name=${encodeURIComponent(participantName)}`;
            }

            document.getElementById('linkText').textContent = link;
            document.getElementById('generatedLink').style.display = 'block';

            // Store for copying
            window.currentLink = link;
        };

        window.copyLink = function() {
            navigator.clipboard.writeText(window.currentLink).then(() => {
                showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!');
            });
        };

        // Load Offices
        async function loadOffices() {
            try {
                const querySnapshot = await getDocs(collection(db, 'responses-offices'));
                allOffices = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allOffices.push({
                        id: doc.id,
                        ...data
                    });
                });

                // Sort by last updated
                allOffices.sort((a, b) => {
                    const timeA = a.lastUpdated?.toMillis() || a.timestamp?.toMillis() || 0;
                    const timeB = b.lastUpdated?.toMillis() || b.timestamp?.toMillis() || 0;
                    return timeB - timeA;
                });

                updateStats();
                displayOffices();
            } catch (error) {
                console.error('Error loading offices:', error);
                document.getElementById('officesContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">âŒ</div>
                        <div class="empty-text">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                    </div>
                `;
            }
        }

        function updateStats() {
            const total = allOffices.length;
            const completed = allOffices.filter(o => o.isFinal === true).length;
            const incomplete = total - completed;
            
            let totalProgress = 0;
            allOffices.forEach(o => {
                totalProgress += (o.progress?.percentage || 0);
            });
            const avgProgress = total > 0 ? Math.round(totalProgress / total) : 0;

            document.getElementById('totalOffices').textContent = total;
            document.getElementById('completedOffices').textContent = completed;
            document.getElementById('incompleteOffices').textContent = incomplete;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }

        function displayOffices() {
            const container = document.getElementById('officesContainer');
            
            if (allOffices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ Ø¨Ø¹Ø¯</div>
                    </div>
                `;
                return;
            }

            let filteredOffices = allOffices;

            if (currentFilter === 'complete') {
                filteredOffices = allOffices.filter(o => o.isFinal === true);
            } else if (currentFilter === 'incomplete') {
                filteredOffices = allOffices.filter(o => o.isFinal !== true && (o.progress?.answered || 0) > 0);
            } else if (currentFilter === 'new') {
                filteredOffices = allOffices.filter(o => (o.progress?.answered || 0) === 0);
            }

            if (filteredOffices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”</div>
                        <div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙƒØ§ØªØ¨ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</div>
                    </div>
                `;
                return;
            }

            let html = '<div class="offices-grid">';

            filteredOffices.forEach(office => {
                const percentage = office.progress?.percentage || 0;
                const answered = office.progress?.answered || 0;
                const total = office.progress?.total || 50;
                
                let status = 'new';
                let statusText = 'Ø¬Ø¯ÙŠØ¯';
                
                if (office.isFinal) {
                    status = 'complete';
                    statusText = 'Ù…ÙƒØªÙ…Ù„';
                } else if (answered > 0) {
                    status = 'incomplete';
                    statusText = 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„';
                }

                const lastUpdate = office.lastUpdated?.toDate() || office.timestamp?.toDate();
                const lastUpdateText = lastUpdate ? formatDate(lastUpdate) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

                html += `
                    <div class="office-card" onclick="viewOffice('${office.id}')">
                        <div class="office-header">
                            <div>
                                <div class="office-name">${office.officeName || office.id}</div>
                                <div class="meta-item">ğŸ‘¤ ${office.participantName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                            </div>
                            <div class="office-status status-${status}">${statusText}</div>
                        </div>

                        <div class="office-meta">
                            <div class="meta-item">
                                ğŸ“… ${lastUpdateText}
                            </div>
                            <div class="meta-item">
                                âœ… ${answered} / ${total} Ø³Ø¤Ø§Ù„
                            </div>
                        </div>

                        <div class="progress-section">
                            <div class="progress-info">
                                <span class="progress-label">Ø§Ù„ØªÙ‚Ø¯Ù…</span>
                                <span class="progress-percentage">${percentage}%</span>
                            </div>
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>

                        <div class="office-actions">
                            <button class="btn btn-primary btn-small" onclick="event.stopPropagation(); viewOffice('${office.id}')">
                                ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="event.stopPropagation(); copyOfficeLink('${office.officeName || office.id}')">
                                ğŸ”— Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                            </button>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        window.filterOffices = function(filter) {
            currentFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
            
            displayOffices();
        };

        window.viewOffice = async function(officeId) {
            try {
                const docRef = doc(db, 'responses-offices', officeId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    alert('âŒ Ø§Ù„Ù…ÙƒØªØ¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                const data = docSnap.data();
                displayOfficeDetails(data);
            } catch (error) {
                console.error('Error loading office details:', error);
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„');
            }
        };

        function displayOfficeDetails(data) {
            document.getElementById('modalOfficeName').textContent = data.officeName || 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨';
            
            const answers = data.answers || {};
            let html = '';

            // Office Info
            html += `
                <div class="answer-section">
                    <div class="answer-axis-title">ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨</div>
                    <div class="answer-section-group">
                        <div class="answer-item">
                            <div class="answer-question">Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨</div>
                            <div class="answer-value">${data.officeName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        <div class="answer-item">
                            <div class="answer-question">Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</div>
                            <div class="answer-value">${data.participantName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        </div>
                        <div class="answer-item">
                            <div class="answer-question">Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ</div>
                            <div class="answer-value">${data.isFinal ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 'â³ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'}</div>
                        </div>
                        <div class="answer-item">
                            <div class="answer-question">Ø§Ù„ØªÙ‚Ø¯Ù…</div>
                            <div class="answer-value">${data.progress?.answered || 0} Ù…Ù† ${data.progress?.total || 50} Ø³Ø¤Ø§Ù„ (${data.progress?.percentage || 0}%)</div>
                        </div>
                    </div>
                </div>
            `;

            // Answers by Axis
            const axesInfo = {
                axis1: { name: 'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙˆØ§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ù…Ø¤Ø³Ø³ÙŠ', icon: 'ğŸ—ï¸' },
                axis2: { name: 'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†', icon: 'ğŸ‘¥' },
                axis3: { name: 'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠ ÙˆØ§Ù„Ø£Ø«Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ', icon: 'ğŸ¯' },
                axis4: { name: 'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ø´Ø±Ø§ÙƒØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©', icon: 'ğŸ’°' },
                axis5: { name: 'Ø§Ù„Ù…Ø­ÙˆØ± Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØªØ´Ø§Ø± Ø§Ù„Ù…Ø­Ù„ÙŠ', icon: 'ğŸ—ºï¸' }
            };

            Object.keys(answers).forEach(axisId => {
                const axisData = answers[axisId];
                const axisInfo = axesInfo[axisId] || { name: axisId, icon: 'ğŸ“Œ' };

                html += `<div class="answer-section">`;
                html += `<div class="answer-axis-title">${axisInfo.icon} ${axisInfo.name}</div>`;

                Object.keys(axisData).forEach(sectionId => {
                    const sectionData = axisData[sectionId];
                    
                    html += `<div class="answer-section-group">`;
                    
                    let questionNumber = 0;
                    Object.keys(sectionData).forEach(questionId => {
                        // Skip follow-up questions in the main list
                        if (questionId.includes('_followup')) return;
                        
                        questionNumber++;
                        const answerData = sectionData[questionId];
                        const answer = answerData.answer;
                        
                        const displayAnswer = Array.isArray(answer) ? answer.join(', ') : answer;
                        
                        html += `<div class="answer-item">`;
                        html += `<div class="answer-question">Ø³${questionNumber}: ${questionId}</div>`;
                        html += `<div class="answer-value">${displayAnswer}</div>`;
                        
                        // Check for follow-up answers
                        const followUpId = questionId + '_followup';
                        const followUp2Id = questionId + '_followup2';
                        
                        if (sectionData[followUpId]) {
                            const followUpAnswer = sectionData[followUpId].answer;
                            const displayFollowUp = Array.isArray(followUpAnswer) ? followUpAnswer.join(', ') : followUpAnswer;
                            html += `
                                <div class="answer-followup">
                                    <span class="followup-label">ğŸ’­ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªÙƒÙ…ÙŠÙ„ÙŠ:</span>
                                    <div class="followup-value">${displayFollowUp}</div>
                                </div>
                            `;
                        }
                        
                        if (sectionData[followUp2Id]) {
                            const followUp2Answer = sectionData[followUp2Id].answer;
                            const displayFollowUp2 = Array.isArray(followUp2Answer) ? followUp2Answer.join(', ') : followUp2Answer;
                            html += `
                                <div class="answer-followup" style="margin-top: 10px;">
                                    <span class="followup-label">ğŸ’­ğŸ’­ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªÙƒÙ…ÙŠÙ„ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ:</span>
                                    <div class="followup-value">${displayFollowUp2}</div>
                                </div>
                            `;
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `</div>`;
                });

                html += `</div>`;
            });

            if (Object.keys(answers).length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¨Ø¹Ø¯</div>
                    </div>
                `;
            }

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('officeModal').classList.remove('hidden');
        }

        window.closeModal = function() {
            document.getElementById('officeModal').classList.add('hidden');
        };

        window.copyOfficeLink = function(officeName) {
            const baseUrl = window.location.origin + window.location.pathname.replace('admin-offices.html', 'questions-offices.html');
            const link = `${baseUrl}?office=${encodeURIComponent(officeName)}`;
            
            navigator.clipboard.writeText(link).then(() => {
                showToast('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙƒØªØ¨ Ø¨Ù†Ø¬Ø§Ø­!');
            });
        };

        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 60) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (hours < 24) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            if (days < 7) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
            
            return date.toLocaleDateString('ar-EG');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Initialize
        loadOffices();

        // Refresh every 30 seconds
        setInterval(loadOffices, 30000);
    </script>
</body>
</html>
