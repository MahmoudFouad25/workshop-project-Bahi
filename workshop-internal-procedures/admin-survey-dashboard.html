<!DOCTYPE html>  
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© | ØµÙ†Ø§Ø¹ Ø§Ù„Ø­ÙŠØ§Ø©</title>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --gray: #6c757d;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }
        
        /* ============================================ */
        /* Header */
        /* ============================================ */
        .header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-title {
            flex: 1;
        }
        
        .header-title h1 {
            font-size: 28px;
            color: var(--dark);
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .header-title p {
            color: var(--gray);
            font-size: 14px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }
        
        .btn-secondary:hover {
            background: var(--light);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        /* ============================================ */
        /* Stats Overview */
        /* ============================================ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 50px rgba(0,0,0,0.15);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 0 0 0 100px;
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
            display: block;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
            font-weight: 600;
        }
        
        .stat-trend {
            font-size: 12px;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .stat-trend.up {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }
        
        .stat-trend.down {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        /* ============================================ */
        /* Main Content */
        /* ============================================ */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        .section-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .section-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title .icon {
            font-size: 28px;
        }
        
        .section-badge {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        /* ============================================ */
        /* Filters */
        /* ============================================ */
        .filters {
            background: var(--light);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .filter-select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 18px;
        }
        
        /* ============================================ */
        /* Charts */
        /* ============================================ */
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .chart-small {
            height: 300px;
        }
        
        /* ============================================ */
        /* Lists */
        /* ============================================ */
        .list-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .list-item {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            border-right: 5px solid var(--primary);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .list-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .list-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            flex: 1;
        }
        
        .list-item-badge {
            background: var(--primary);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .list-item-content {
            font-size: 14px;
            color: var(--gray);
            line-height: 1.6;
        }
        
        .list-item-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 13px;
            color: var(--gray);
        }
        
        .list-item-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* ============================================ */
        /* Priority List */
        /* ============================================ */
        .priority-list {
            counter-reset: priority;
        }
        
        .priority-item {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            gap: 20px;
            align-items: flex-start;
            transition: all 0.3s;
        }
        
        .priority-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .priority-number {
            counter-increment: priority;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .priority-number::before {
            content: counter(priority);
        }
        
        .priority-content {
            flex: 1;
        }
        
        .priority-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
        }
        
        .priority-count {
            font-size: 13px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .priority-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .priority-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        /* ============================================ */
        /* AI Insights */
        /* ============================================ */
        .ai-insights {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .ai-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .ai-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .ai-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .ai-content {
            font-size: 15px;
            line-height: 1.8;
            color: var(--dark);
        }
        
        .ai-content ul {
            margin: 15px 0;
            padding-right: 25px;
        }
        
        .ai-content li {
            margin-bottom: 10px;
        }
        
        .ai-loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
            font-weight: 600;
        }
        
        .ai-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ============================================ */
        /* Loading Overlay */
        /* ============================================ */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        
        .loading-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* ============================================ */
        /* Tabs */
        /* ============================================ */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--light);
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: var(--gray);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab:hover {
            color: var(--primary);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ============================================ */
        /* Empty State */
        /* ============================================ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .empty-state-subtext {
            font-size: 14px;
        }
        
        /* ============================================ */
        /* Responsive */
        /* ============================================ */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-title h1 {
                font-size: 22px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .section-card {
                padding: 20px;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .priority-item {
                flex-direction: column;
                text-align: center;
            }
            
            .priority-number {
                margin: 0 auto;
            }
        }

        /* ============================================ */
        /* Response Cards Styling */
        /* ============================================ */
        .response-card {
            background: white;
            border-radius: 15px;
            padding: 0;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .response-card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .response-card-header {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .response-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            flex-shrink: 0;
        }
        
        .response-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .response-meta {
            font-size: 13px;
            color: var(--gray);
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .btn-icon-danger {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }
        
        .btn-icon-danger:hover {
            background: var(--danger);
            color: white;
            transform: scale(1.1);
        }
        
        /* Quick Stats */
        .response-quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px 25px;
            background: white;
        }
        
        .quick-stat {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 15px;
            background: var(--light);
            border-radius: 10px;
        }
        
        .quick-stat-icon {
            font-size: 28px;
        }
        
        .quick-stat-content {
            flex: 1;
        }
        
        .quick-stat-label {
            font-size: 12px;
            color: var(--gray);
            margin-bottom: 3px;
        }
        
        .quick-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* Details Section */
        .response-details {
            border-top: 2px solid #e0e0e0;
        }
        
        .response-summary {
            padding: 18px 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            background: white;
            transition: all 0.3s;
            user-select: none;
        }
        
        .response-summary:hover {
            background: var(--light);
        }
        
        .response-details[open] .response-summary {
            background: var(--light);
            border-bottom: 2px solid #e0e0e0;
        }
        
        .response-details-content {
            padding: 25px;
            background: #fafafa;
        }
        
        /* Detail Sections */
        .detail-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-right: 5px solid var(--primary);
        }
        
        .detail-section-warning {
            border-right-color: #ffc107;
            background: #fffef8;
        }
        
        .detail-section-info {
            border-right-color: #17a2b8;
            background: #f8fdff;
        }
        
        .detail-section-success {
            border-right-color: #28a745;
            background: #f8fff9;
        }
        
        .detail-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .detail-icon {
            font-size: 24px;
        }
        
        /* Detail Grid */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .detail-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .detail-item {
            display: flex;
            gap: 10px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-label {
            font-weight: 600;
            color: var(--dark);
            min-width: 150px;
        }
        
        .detail-value {
            color: var(--gray);
            flex: 1;
        }
        
        .detail-item-text {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-right: 3px solid var(--primary);
        }
        
        .detail-label-text {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 15px;
        }
        
        .detail-value-text {
            color: var(--gray);
            line-height: 1.7;
            font-size: 14px;
        }
        
        .detail-item-special {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .detail-item-special strong {
            display: block;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .priority-badge {
            background: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-right: 3px solid var(--primary);
            font-size: 14px;
            color: var(--dark);
        }
        
        /* Detail Rating */
        .detail-rating {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .detail-rating-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .detail-rating-value {
            font-weight: 700;
            font-size: 16px;
        }
        
        .detail-rating-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .detail-rating-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* ============================================ */
        /* Analysis Formatting Enhancements */
        /* ============================================ */
        .ai-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .ai-content th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 12px 15px;
            text-align: right;
            font-weight: 700;
            font-size: 14px;
        }
        
        .ai-content td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            color: #555;
        }
        
        .ai-content tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .ai-content tr:hover {
            background: #e3f2fd;
            transition: background 0.3s;
        }
        
        .ai-content h1 {
            font-size: 32px;
            color: var(--primary);
            margin-top: 40px;
            margin-bottom: 20px;
            font-weight: 800;
            border-bottom: 4px solid var(--primary);
            padding-bottom: 15px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 12px;
        }
        
        .ai-content h2 {
            font-size: 24px;
            color: var(--dark);
            margin-top: 35px;
            margin-bottom: 15px;
            font-weight: 700;
            border-right: 5px solid var(--secondary);
            padding-right: 15px;
        }
        
        .ai-content h3 {
            font-size: 20px;
            color: var(--dark);
            margin-top: 25px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .ai-content hr {
            border: none;
            border-top: 2px solid #e0e0e0;
            margin: 30px 0;
        }
        
        .ai-content ul {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .ai-content li {
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .ai-content code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: #d63384;
        }
        
        .ai-content strong {
            color: var(--dark);
            font-weight: 700;
        }

        
        /* ============================================ */
        /* Print Styles */
        /* ============================================ */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header-actions,
            .filters,
            .btn {
                display: none !important;
            }
            
            .section-card {
                page-break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>
    </div>

    <!-- Header -->
    <div class="header">
        <div class="header-title">
            <h1>ğŸ¯ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ø³ØªØ¨ÙŠØ§Ù† Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h1>
            <p>ÙˆØ±Ø´Ø©: Ù…Ù† Ø§Ù„ÙÙˆØ¶Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù… | 19 Ù†ÙˆÙÙ…Ø¨Ø± 2025</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="refreshData()">
                ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            </button>
            <button class="btn btn-success" onclick="loadExistingAnalysis()">
                ğŸ“Š Ø¹Ø±Ø¶ Ø¢Ø®Ø± ØªØ­Ù„ÙŠÙ„
            </button>
            <button class="btn btn-secondary" onclick="forceNewAnalysis()" style="background: #6c757d;">
                ğŸ†• ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ (ÙŠØ³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯)
            </button>
            <button class="btn btn-primary" onclick="exportData()">
                ğŸ“¥ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±
            </button>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-grid" id="stats-grid">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ù€ JavaScript -->
    </div>

    <!-- Main Content -->
    <div class="main-content">
        
        <!-- AI Insights Section -->
        <div class="section-card">
            <div class="ai-insights" id="ai-insights">
                <div class="ai-header">
                    <div class="ai-icon">ğŸ¤–</div>
                    <div class="ai-title">Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ Ø¨ÙˆØ§Ø³Ø·Ø© Claude AI</div>
                </div>
                <div class="ai-content" id="ai-content">
                    <div class="ai-loading">
                        <div class="ai-spinner"></div>
                        <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Firebase...</span>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="section-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('overview')">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                <button class="tab" onclick="switchTab('bottlenecks')">ğŸš§ Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª</button>
                <button class="tab" onclick="switchTab('priorities')">ğŸ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª</button>
                <button class="tab" onclick="switchTab('departments')">ğŸ¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
                <button class="tab" onclick="switchTab('stories')">ğŸ“– Ø§Ù„Ù‚ØµØµ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©</button>
                <button class="tab" onclick="switchTab('responses')">ğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯</button>
            </div>

            <!-- Tab: Overview -->
            <div class="tab-content active" id="tab-overview">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>

            <!-- Tab: Bottlenecks -->
            <div class="tab-content" id="tab-bottlenecks">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>

            <!-- Tab: Priorities -->
            <div class="tab-content" id="tab-priorities">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>

            <!-- Tab: Departments -->
            <div class="tab-content" id="tab-departments">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>

            <!-- Tab: Stories -->
            <div class="tab-content" id="tab-stories">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>

            <!-- Tab: Responses -->
            <div class="tab-content" id="tab-responses">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡ Ø¨Ø§Ù„Ù€ JavaScript -->
            </div>
        </div>
    </div>

    <!-- Config -->
    <script src="../config.js"></script>

  <script>
        // ============================================
        // Initialize Firebase
        // ============================================
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // ============================================
        // Global Variables
        // ============================================
        let allResponses = [];
        let filteredResponses = [];
        let charts = {};
        
        // ============================================
        // Load Data on Page Load
        // ============================================
        window.addEventListener('load', async function() {
            showLoading();
            await loadAllData();
            hideLoading();
        });
        
        // ============================================
        // Show/Hide Loading
        // ============================================
        function showLoading() {
            document.getElementById('loading-overlay').classList.add('show');
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').classList.remove('show');
        }
        
        // ============================================
        // Load All Data
        // ============================================
        async function loadAllData() {
            try {
                const snapshot = await db.collection('internal-procedures-survey')
                    .orderBy('timestamp', 'asc')
                    .get();
                
                allResponses = [];
                snapshot.forEach(doc => {
                    allResponses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                filteredResponses = [...allResponses];
                
                console.log('Loaded responses:', allResponses.length);
                
                // Render all sections
                renderStats();
                renderOverviewTab();
                renderBottlenecksTab();
                renderPrioritiesTab();
                renderDepartmentsTab();
                renderStoriesTab();
                renderResponsesTab();
                
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
            // Auto-load AI analysis from Firebase
                await autoLoadAnalysis();
        }
      // ============================================
        // Auto-Load Analysis on Page Load
        // ============================================
        async function autoLoadAnalysis() {
            console.log('ğŸ” Auto-loading analysis from Firebase...');
            
            try {
                const snapshot = await db.collection('internal-procedures-analysis')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    console.log('âš ï¸ No analysis found in Firebase');
                    const aiContent = document.getElementById('ai-content');
                    aiContent.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--gray);">
                            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                            <p style="font-size: 16px; margin-bottom: 15px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„ Ù…Ø­ÙÙˆØ¸</p>
                            <button class="btn btn-primary" onclick="forceNewAnalysis()">
                                ğŸ¤– Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const doc = snapshot.docs[0];
                const data = doc.data();
                
                console.log('âœ… Found analysis, timestamp:', data.timestamp);
                
                if (data.fullText) {
                    const docTime = data.timestamp?.toDate();
                    const timeAgo = docTime ? formatTimeAgo(docTime) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    
                    displayAnalysis(data.fullText, true, timeAgo, data.totalResponses);
                } else {
                    throw new Error('Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø§Ù„Ù†Øµ ÙØ§Ø±Øº');
                }
                
            } catch (error) {
                console.error('âŒ Error auto-loading analysis:', error);
                const aiContent = document.getElementById('ai-content');
                aiContent.innerHTML = `
                    <div style="color: var(--danger); padding: 20px; text-align: center;">
                        <p>âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„</p>
                        <button class="btn btn-secondary" onclick="autoLoadAnalysis()">
                            ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================
        // Force New Analysis (Use with Caution!)
        // ============================================
        async function forceNewAnalysis() {
            const confirmed = confirm(
                'âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ø°Ø§ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ÙˆØ³Ø­Ø¨ Ù…Ù† Ø±ØµÙŠØ¯ Claude API.\n\n' +
                'ÙŠÙˆØ¬Ø¯ Ø¨Ø§Ù„ÙØ¹Ù„ ' + (await countAnalyses()) + ' ØªØ­Ù„ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ ÙÙŠ Firebase.\n\n' +
                'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ØŸ'
            );
            
            if (!confirmed) return;
            
            await triggerAIAnalysis();
        }
        
        // ============================================
        // Count Existing Analyses
        // ============================================
        async function countAnalyses() {
            try {
                const snapshot = await db.collection('internal-procedures-analysis').get();
                return snapshot.size;
            } catch (error) {
                return 0;
            }
        }
        
        // ============================================
        // Display Analysis (Updated)
        // ============================================
        function displayAnalysis(analysisText, fromCache, timeAgo, totalResponses) {
            const aiContent = document.getElementById('ai-content');
            
            // Format the text
            const formattedText = formatAnalysisText(analysisText);
            
            aiContent.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 15px 20px; border-radius: 12px; margin-bottom: 25px; border-right: 5px solid #4caf50;">
                    <div>
                        <strong style="font-size: 16px;">âœ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ Ù…Ù† Firebase</strong>
                        <div style="font-size: 13px; color: #555; margin-top: 5px;">
                            ğŸ“… ${timeAgo} â€¢ ğŸ“Š ${totalResponses} Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                        </div>
                    </div>
                    <button class="btn btn-secondary" onclick="forceNewAnalysis()" style="font-size: 13px; padding: 8px 16px;">
                        ğŸ†• ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
                <div style="line-height: 1.9; white-space: pre-wrap; font-size: 15px; color: #333;">
                    ${formattedText}
                </div>
            `;
            
            console.log('âœ… Analysis displayed successfully');
        }
        
        // ============================================
        // Format Time Ago
        // ============================================
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `Ù…Ù†Ø° ${days} ÙŠÙˆÙ…`;
            if (hours > 0) return `Ù…Ù†Ø° ${hours} Ø³Ø§Ø¹Ø©`;
            if (minutes > 0) return `Ù…Ù†Ø° ${minutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
            return 'Ø§Ù„Ø¢Ù†';
        }
        
        // ============================================
        // Format Analysis Text (Enhanced)
        // ============================================
        // ============================================
        // Format Analysis Text (Professional)
        // ============================================
        function formatAnalysisText(text) {
            // Split into lines
            const lines = text.split('\n');
            let formatted = '';
            let inTable = false;
            let tableRows = [];
            let inList = false;
            let listItems = [];
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();
                
                // Skip empty lines
                if (line === '') {
                    if (inTable) {
                        formatted += formatTable(tableRows);
                        tableRows = [];
                        inTable = false;
                    }
                    if (inList) {
                        formatted += formatList(listItems);
                        listItems = [];
                        inList = false;
                    }
                    formatted += '<div style="height: 15px;"></div>';
                    continue;
                }
                
                // Detect tables
                if (line.startsWith('|')) {
                    inTable = true;
                    tableRows.push(line);
                    continue;
                }
                
                // If we were in a table and now we're not
                if (inTable && !line.startsWith('|')) {
                    formatted += formatTable(tableRows);
                    tableRows = [];
                    inTable = false;
                }
                
                // Detect lists (numbered or bullets)
                if (/^(\d+\.|\*|-|â€¢|âœ…|âŒ|ğŸ”´|ğŸŸ¡|ğŸŸ¢)\s/.test(line)) {
                    inList = true;
                    listItems.push(line);
                    continue;
                }
                
                // If we were in a list and now we're not
                if (inList && !/^(\d+\.|\*|-|â€¢|âœ…|âŒ|ğŸ”´|ğŸŸ¡|ğŸŸ¢)\s/.test(line)) {
                    formatted += formatList(listItems);
                    listItems = [];
                    inList = false;
                }
                
                // Headers
                if (line.startsWith('# ')) {
                    formatted += formatHeader(line, 1);
                } else if (line.startsWith('## ')) {
                    formatted += formatHeader(line, 2);
                } else if (line.startsWith('### ')) {
                    formatted += formatHeader(line, 3);
                } else if (line.startsWith('#### ')) {
                    formatted += formatHeader(line, 4);
                } else if (line === '---') {
                    formatted += '<hr style="border: none; border-top: 2px solid #e0e0e0; margin: 30px 0;">';
                } else {
                    // Regular paragraph
                    formatted += formatParagraph(line);
                }
            }
            
            // Flush remaining table or list
            if (inTable) {
                formatted += formatTable(tableRows);
            }
            if (inList) {
                formatted += formatList(listItems);
            }
            
            return formatted;
        }
        
        // ============================================
        // Format Header
        // ============================================
        function formatHeader(line, level) {
            const text = line.replace(/^#+\s+/, '');
            
            const styles = {
                1: 'font-size: 32px; color: var(--primary); margin-top: 40px; margin-bottom: 20px; font-weight: 800; border-bottom: 4px solid var(--primary); padding-bottom: 15px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 12px;',
                2: 'font-size: 24px; color: var(--dark); margin-top: 35px; margin-bottom: 15px; font-weight: 700; border-right: 5px solid var(--secondary); padding-right: 15px;',
                3: 'font-size: 20px; color: var(--dark); margin-top: 25px; margin-bottom: 12px; font-weight: 600;',
                4: 'font-size: 18px; color: #555; margin-top: 20px; margin-bottom: 10px; font-weight: 600;'
            };
            
            return `<h${level} style="${styles[level]}">${escapeHtml(text)}</h${level}>`;
        }
        
        // ============================================
        // Format Table
        // ============================================
        function formatTable(rows) {
            if (rows.length === 0) return '';
            
            let html = '<div style="overflow-x: auto; margin: 25px 0;"><table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">';
            
            rows.forEach((row, index) => {
                // Skip separator row
                if (row.includes('---')) return;
                
                const cells = row.split('|').filter(c => c.trim() !== '');
                const isHeader = index === 0;
                
                html += '<tr style="' + (isHeader ? 'background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white;' : (index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;')) + '">';
                
                cells.forEach(cell => {
                    const tag = isHeader ? 'th' : 'td';
                    const style = 'padding: 12px 15px; text-align: right; border-bottom: 1px solid #e0e0e0; ' + (isHeader ? 'font-weight: 700; font-size: 14px;' : 'font-size: 14px; color: #555;');
                    html += `<${tag} style="${style}">${formatInlineText(cell.trim())}</${tag}>`;
                });
                
                html += '</tr>';
            });
            
            html += '</table></div>';
            return html;
        }
        
        // ============================================
        // Format List
        // ============================================
        function formatList(items) {
            if (items.length === 0) return '';
            
            let html = '<ul style="list-style: none; padding: 0; margin: 20px 0;">';
            
            items.forEach(item => {
                // Detect emoji/icon at start
                const match = item.match(/^([\d\w]+\.|[â€¢\-âœ…âŒğŸ”´ğŸŸ¡ğŸŸ¢â­ğŸ¯ğŸ“ŠğŸ’¡ğŸš€])\s+(.+)/);
                
                if (match) {
                    const icon = match[1];
                    const text = match[2];
                    
                    // Color coding for status icons
                    let bgColor = '#f8f9fa';
                    let borderColor = '#ddd';
                    
                    if (icon.includes('âœ…') || icon.includes('ğŸŸ¢')) {
                        bgColor = '#e8f5e9';
                        borderColor = '#4caf50';
                    } else if (icon.includes('âŒ') || icon.includes('ğŸ”´')) {
                        bgColor = '#ffebee';
                        borderColor = '#f44336';
                    } else if (icon.includes('ğŸŸ¡')) {
                        bgColor = '#fff8e1';
                        borderColor = '#ffc107';
                    }
                    
                    html += `
                        <li style="padding: 12px 15px; margin-bottom: 8px; background: ${bgColor}; border-right: 4px solid ${borderColor}; border-radius: 8px; display: flex; gap: 10px; align-items: flex-start;">
                            <span style="font-size: 18px; flex-shrink: 0;">${icon}</span>
                            <span style="flex: 1; line-height: 1.6;">${formatInlineText(text)}</span>
                        </li>
                    `;
                } else {
                    html += `
                        <li style="padding: 12px 15px; margin-bottom: 8px; background: #f8f9fa; border-right: 4px solid #ddd; border-radius: 8px;">
                            ${formatInlineText(item)}
                        </li>
                    `;
                }
            });
            
            html += '</ul>';
            return html;
        }
        
        // ============================================
        // Format Paragraph
        // ============================================
        function formatParagraph(text) {
            // Special paragraph types
            if (text.startsWith('**') && text.endsWith('**')) {
                // Bold paragraph (like section labels)
                const content = text.replace(/\*\*/g, '');
                return `<div style="padding: 15px 20px; background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); border-radius: 10px; margin: 15px 0; font-weight: 700; font-size: 16px; color: var(--primary);">${formatInlineText(content)}</div>`;
            }
            
            return `<p style="margin: 12px 0; line-height: 1.8; color: #333; font-size: 15px;">${formatInlineText(text)}</p>`;
        }
        
        // ============================================
        // Format Inline Text (bold, italic, etc)
        // ============================================
        function formatInlineText(text) {
            // Escape HTML first
            text = escapeHtml(text);
            
            // Bold (**text**)
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color: var(--dark);">$1</strong>');
            
            // Italic (*text*)
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Inline code (`code`)
            text = text.replace(/`(.+?)`/g, '<code style="background: #f4f4f4; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; color: #d63384;">$1</code>');
            
            // Highlight important numbers
            text = text.replace(/(\d+%)/g, '<span style="font-weight: 700; color: var(--primary);">$1</span>');
            text = text.replace(/(\d+\/\d+)/g, '<span style="font-weight: 700; color: var(--secondary);">$1</span>');
            
            return text;
        }
        
        // ============================================
        // Escape HTML
        // ============================================
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        
        // ============================================
        // Render Stats Overview
        // ============================================
        function renderStats() {
            const total = allResponses.length;
            
            if (total === 0) {
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card" style="grid-column: 1 / -1;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“­</div>
                            <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
                            <div class="empty-state-subtext">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¨Ù…Ø¬Ø±Ø¯ Ù…Ù„Ø¡ Ø§Ù„Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª</div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Calculate stats
            const avgRoleClarity = calculateAverage('role_clarity');
            const avgCooperation = calculateAverage('cooperation_quality');
            const avgExpectedImpact = calculateAverage('expected_impact');
            const readinessAvg = calculateAverage('readiness_new_procedures');
            
            // Count by department
            const deptCounts = countByField('department');
            const topDept = Object.entries(deptCounts).sort((a, b) => b[1] - a[1])[0];
            
            // Count bottlenecks
            const bottleneckMentions = allResponses.filter(r => 
                r.bottleneck_story && r.bottleneck_story.trim().length > 0
            ).length;
            
            // Count SLA needs
            const slaImpactCounts = countByField('sla_impact');
            const slaPositive = (slaImpactCounts['Ù†Ø¹Ù…ØŒ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§'] || 0) + 
                               (slaImpactCounts['Ù†Ø¹Ù…ØŒ Ø¨Ø´ÙƒÙ„ Ù…Ù„Ø­ÙˆØ¸'] || 0);
            
            const statsHTML = `
                <div class="stat-card">
                    <span class="stat-icon">ğŸ“Š</span>
                    <div class="stat-value">${total}</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø§Øª</div>
                    <div class="stat-trend up">ğŸ“ˆ +${total} Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">â­</span>
                    <div class="stat-value">${avgRoleClarity.toFixed(1)}/10</div>
                    <div class="stat-label">Ù…ØªÙˆØ³Ø· ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ±</div>
                    <div class="stat-trend ${avgRoleClarity >= 7 ? 'up' : 'down'}">
                        ${avgRoleClarity >= 7 ? 'âœ…' : 'âš ï¸'} 
                        ${avgRoleClarity >= 7 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸ¤</span>
                    <div class="stat-value">${avgCooperation.toFixed(1)}/10</div>
                    <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ†</div>
                    <div class="stat-trend ${avgCooperation >= 7 ? 'up' : 'down'}">
                        ${avgCooperation >= 7 ? 'âœ…' : 'âš ï¸'} 
                        ${avgCooperation >= 7 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸ¯</span>
                    <div class="stat-value">${avgExpectedImpact.toFixed(1)}/10</div>
                    <div class="stat-label">Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØ±Ø´Ø©</div>
                    <div class="stat-trend ${avgExpectedImpact >= 8 ? 'up' : avgExpectedImpact >= 6 ? 'up' : 'down'}">
                        ${avgExpectedImpact >= 8 ? 'ğŸ”¥' : avgExpectedImpact >= 6 ? 'âœ…' : 'âš ï¸'} 
                        ${avgExpectedImpact >= 8 ? 'ØªÙˆÙ‚Ø¹Ø§Øª Ø¹Ø§Ù„ÙŠØ© Ø¬Ø¯Ø§Ù‹!' : avgExpectedImpact >= 6 ? 'ØªÙˆÙ‚Ø¹Ø§Øª Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©' : 'ØªÙˆÙ‚Ø¹Ø§Øª Ù…ØªÙˆØ§Ø¶Ø¹Ø©'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸš§</span>
                    <div class="stat-value">${bottleneckMentions}</div>
                    <div class="stat-label">Ù‚ØµØµ Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª Ù…ÙˆØ«Ù‚Ø©</div>
                    <div class="stat-trend up">ğŸ“ ${((bottleneckMentions/total)*100).toFixed(0)}% Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸ“‹</span>
                    <div class="stat-value">${((slaPositive/total)*100).toFixed(0)}%</div>
                    <div class="stat-label">ÙŠØ±ÙˆÙ† Ø£Ù† SLAs Ø³ØªØ­Ø³Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡</div>
                    <div class="stat-trend up">âœ… ${slaPositive} Ù…Ù† ${total} Ø´Ø®Øµ</div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸ”¥</span>
                    <div class="stat-value">${readinessAvg.toFixed(1)}/10</div>
                    <div class="stat-label">Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</div>
                    <div class="stat-trend ${readinessAvg >= 7 ? 'up' : 'down'}">
                        ${readinessAvg >= 7 ? 'âœ… Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ø¹Ø§Ù„ÙŠ' : 'âš ï¸ Ù…Ù‚Ø§ÙˆÙ…Ø© Ù…Ø­ØªÙ…Ù„Ø©'}
                    </div>
                </div>
                
                <div class="stat-card">
                    <span class="stat-icon">ğŸ¢</span>
                    <div class="stat-value">${Object.keys(deptCounts).length}</div>
                    <div class="stat-label">Ø£Ù‚Ø³Ø§Ù… Ù…Ø´Ø§Ø±ÙƒØ©</div>
                    <div class="stat-trend up">ğŸ“Š Ø£Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ©: ${topDept ? topDept[0] : 'N/A'}</div>
                </div>
            `;
            
            document.getElementById('stats-grid').innerHTML = statsHTML;
        }
        
        // ============================================
        // Render Overview Tab
        // ============================================
        function renderOverviewTab() {
            const container = document.getElementById('tab-overview');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            const html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">ğŸ“Š Ø§Ù„ØªÙˆØ²ÙŠØ¹Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h3>
                
                <!-- Row 1: Department & Experience -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-departments"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®Ø¨Ø±Ø§Øª</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-experience"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: Clarity & Cooperation -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª (1-10)</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-role-clarity"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (1-10)</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-cooperation"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: Procedures & Training -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-documented"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: var(--dark);">Ù…Ø¯Ø© ØªØ¯Ø±ÙŠØ¨ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h4>
                        <div class="chart-container chart-small">
                            <canvas id="chart-training"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Row 4: Expected Impact -->
                <div style="margin-bottom: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark);">Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØ±Ø´Ø© (1-10)</h4>
                    <div class="chart-container">
                        <canvas id="chart-expected-impact"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render charts
            renderDepartmentsChart();
            renderExperienceChart();
            renderRoleClarityChart();
            renderCooperationChart();
            renderDocumentedChart();
            renderTrainingChart();
            renderExpectedImpactChart();
        }
        
        // ============================================
        // Render Bottlenecks Tab
        // ============================================
        function renderBottlenecksTab() {
            const container = document.getElementById('tab-bottlenecks');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸš§</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            // Analyze time wasters
            const timeWasters = {};
            allResponses.forEach(r => {
                if (r.time_wasters && Array.isArray(r.time_wasters)) {
                    r.time_wasters.forEach(w => {
                        timeWasters[w] = (timeWasters[w] || 0) + 1;
                    });
                }
            });
            
            const sortedWasters = Object.entries(timeWasters)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Analyze slow departments
            const slowDepts = countByField('slow_department');
            const sortedSlowDepts = Object.entries(slowDepts)
                .filter(([dept, count]) => dept !== 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ£Ø®ÙŠØ±' && dept !== 'Ø£ÙØ¶Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©' && dept !== '')
                .sort((a, b) => b[1] - a[1]);
            
            // Analyze delay reasons
            const delayReasons = countByField('delay_main_reason');
            const sortedDelayReasons = Object.entries(delayReasons)
                .sort((a, b) => b[1] - a[1]);
            
            // Collect bottleneck stories
            const stories = allResponses
                .filter(r => r.bottleneck_story && r.bottleneck_story.trim().length > 50)
                .map(r => ({
                    story: r.bottleneck_story,
                    department: r.department,
                    experience: r.experience
                }));
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">ğŸš§ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¹ÙˆØ§Ø¦Ù‚</h3>
                
                <!-- Top Time Wasters -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                        <span>â°</span>
                        Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ø§Ù„ØªÙŠ ØªØ¶ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª ÙˆØªØ¹Ø·Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²
                    </h4>
                    <div class="priority-list">
            `;
            
            sortedWasters.forEach(([item, count]) => {
                const percentage = ((count / allResponses.length) * 100).toFixed(0);
                html += `
                    <div class="priority-item">
                        <div class="priority-number"></div>
                        <div class="priority-content">
                            <div class="priority-title">${item}</div>
                            <div class="priority-count">
                                <span>ğŸ‘¥ ${count} Ø´Ø®Øµ</span>
                                <span>â€¢</span>
                                <span>${percentage}% Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</span>
                            </div>
                            <div class="priority-bar">
                                <div class="priority-bar-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <!-- Slow Departments -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ¢</span>
                        Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªÙŠ ÙŠÙˆØ§Ø¬Ù‡ Ù…Ø¹Ù‡Ø§ Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ØªØ£Ø®ÙŠØ± Ø£Ùˆ ØµØ¹ÙˆØ¨Ø©
                    </h4>
            `;
            
            if (sortedSlowDepts.length > 0) {
                html += `<div class="priority-list">`;
                sortedSlowDepts.forEach(([dept, count]) => {
                    const percentage = ((count / allResponses.length) * 100).toFixed(0);
                    html += `
                        <div class="priority-item">
                            <div class="priority-number"></div>
                            <div class="priority-content">
                                <div class="priority-title">${dept}</div>
                                <div class="priority-count">
                                    <span>ğŸ‘¥ ${count} Ø´ÙƒÙˆÙ‰</span>
                                    <span>â€¢</span>
                                    <span>${percentage}% Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</span>
                                </div>
                                <div class="priority-bar">
                                    <div class="priority-bar-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: var(--gray);">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´ÙƒØ§ÙˆÙ‰ Ù…Ø­Ø¯Ø¯Ø©</p>`;
            }
            
            html += `
                </div>
                
                <!-- Delay Reasons -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                        <span>âš ï¸</span>
                        Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                    </h4>
                    <div class="chart-container chart-small">
                        <canvas id="chart-delay-reasons"></canvas>
                    </div>
                </div>
                
                <!-- Bottleneck Stories -->
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                        <span>ğŸ“–</span>
                        Ù‚ØµØµ ÙˆØ§Ù‚Ø¹ÙŠØ© Ø¹Ù† Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª (${stories.length} Ù‚ØµØ©)
                    </h4>
            `;
            
            if (stories.length > 0) {
                html += `<div class="list-container">`;
                stories.slice(0, 10).forEach((s, index) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© #${index + 1}</div>
                                <div class="list-item-badge">${s.department}</div>
                            </div>
                            <div class="list-item-content">${s.story}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.experience}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
                
                if (stories.length > 10) {
                    html += `<p style="text-align: center; margin-top: 20px; color: var(--gray);">+ ${stories.length - 10} Ù‚ØµØ© Ø£Ø®Ø±Ù‰</p>`;
                }
            } else {
                html += `<p style="color: var(--gray);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØµ Ù…ÙˆØ«Ù‚Ø©</p>`;
            }
            
            html += `</div>`;
            
            container.innerHTML = html;
            
            // Render delay reasons chart
            renderDelayReasonsChart(sortedDelayReasons);
        }
        
        // ============================================
        // Render Priorities Tab
        // ============================================
        function renderPrioritiesTab() {
            const container = document.getElementById('tab-priorities');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ¯</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            // Collect SOP priorities with filtering
            const sopPriorities = {};
            allResponses.forEach(r => {
                [r.sop_priority_1, r.sop_priority_2, r.sop_priority_3].forEach(sop => {
                    if (isValidResponse(sop)) {
                        const key = sop.trim();
                        sopPriorities[key] = (sopPriorities[key] || 0) + 1;
                    }
                });
            });
            
            const sortedSOPs = Object.entries(sopPriorities)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            // Collect SLA priorities with filtering
            const slaPriorities = {};
            allResponses.forEach(r => {
                [r.sla_priority_1, r.sla_priority_2, r.sla_priority_3].forEach(sla => {
                    if (isValidResponse(sla)) {
                        const key = sla.trim();
                        slaPriorities[key] = (slaPriorities[key] || 0) + 1;
                    }
                });
            });
            
            const sortedSLAs = Object.entries(slaPriorities)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);
            
            // Collect magic fixes with filtering
            const magicFixes = {};
            allResponses.forEach(r => {
                [r.magic_fix_1, r.magic_fix_2, r.magic_fix_3].forEach(fix => {
                    if (isValidResponse(fix, 10)) { // minimum 10 chars for magic fixes
                        const key = fix.trim();
                        magicFixes[key] = (magicFixes[key] || 0) + 1;
                    }
                });
            });
            
            const sortedFixes = Object.entries(magicFixes)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">ğŸ¯ Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª</h3>
            `;
            
            // SOPs Priority
            if (sortedSOPs.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ“‹</span>
                            Ø£Ù‡Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© Ù„Ù€ SOPs Ù…ÙˆØ­Ø¯Ø© (${sortedSOPs.length} Ø¹Ù…Ù„ÙŠØ©)
                        </h4>
                        <div class="priority-list">
                `;
                
                sortedSOPs.forEach(([sop, count]) => {
                    const percentage = ((count / allResponses.length) * 100).toFixed(0);
                    html += `
                        <div class="priority-item">
                            <div class="priority-number"></div>
                            <div class="priority-content">
                                <div class="priority-title">${sop}</div>
                                <div class="priority-count">
                                    <span>ğŸ‘¥ ${count} Ø´Ø®Øµ</span>
                                    <span>â€¢</span>
                                    <span>${percentage}% Ø·Ù„Ø¨ÙˆÙ‡Ø§</span>
                                </div>
                                <div class="priority-bar">
                                    <div class="priority-bar-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ“‹</span>
                            Ø£Ù‡Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© Ù„Ù€ SOPs Ù…ÙˆØ­Ø¯Ø©
                        </h4>
                        <p style="color: var(--gray); padding: 20px; background: var(--light); border-radius: 10px;">
                            âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙŠØ¯Ø©. Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙƒØªØ¨ÙˆØ§ "Ù„Ø§ Ø£Ø¹Ø±Ù" Ø£Ùˆ ØªØ±ÙƒÙˆØ§ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹.
                        </p>
                    </div>
                `;
            }
            
            // SLAs Priority
            if (sortedSLAs.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>â±ï¸</span>
                            Ø£Ù‡Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© Ù„Ù€ SLAs ÙˆØ§Ø¶Ø­Ø© (${sortedSLAs.length} Ø¥Ø¯Ø§Ø±Ø©)
                        </h4>
                        <div class="priority-list">
                `;
                
                sortedSLAs.forEach(([sla, count]) => {
                    const percentage = ((count / allResponses.length) * 100).toFixed(0);
                    html += `
                        <div class="priority-item">
                            <div class="priority-number"></div>
                            <div class="priority-content">
                                <div class="priority-title">${sla}</div>
                                <div class="priority-count">
                                    <span>ğŸ‘¥ ${count} Ø´Ø®Øµ</span>
                                    <span>â€¢</span>
                                    <span>${percentage}% Ø·Ù„Ø¨ÙˆÙ‡Ø§</span>
                                </div>
                                <div class="priority-bar">
                                    <div class="priority-bar-fill" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>â±ï¸</span>
                            Ø£Ù‡Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© Ù„Ù€ SLAs ÙˆØ§Ø¶Ø­Ø©
                        </h4>
                        <p style="color: var(--gray); padding: 20px; background: var(--light); border-radius: 10px;">
                            âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙŠØ¯Ø©. Ù…Ø¹Ø¸Ù… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙƒØªØ¨ÙˆØ§ "Ù„Ø§ Ø£Ø¹Ø±Ù" Ø£Ùˆ ØªØ±ÙƒÙˆØ§ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹.
                        </p>
                    </div>
                `;
            }
            
            // Magic Fixes
            if (sortedFixes.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>âœ¨</span>
                            Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡Ù… Ø¹ØµØ§ Ø³Ø­Ø±ÙŠØ© - Ø£Ù‡Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
                        </h4>
                        <div class="list-container">
                `;
                
                sortedFixes.forEach(([fix, count], index) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">${fix}</div>
                                <div class="list-item-badge">${count} Ø´Ø®Øµ</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            } else {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>âœ¨</span>
                            Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡Ù… Ø¹ØµØ§ Ø³Ø­Ø±ÙŠØ© - Ø£Ù‡Ù… Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
                        </h4>
                        <p style="color: var(--gray); padding: 20px; background: var(--light); border-radius: 10px;">
                            âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ ÙˆØ§Ø¶Ø­Ø© ÙˆÙ…ÙÙŠØ¯Ø©.
                        </p>
                    </div>
                `;
            }
            
            // SLA Impact Chart
            html += `
                <div style="margin-bottom: 40px;">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">ØªØ£Ø«ÙŠØ± Ø§ØªÙØ§Ù‚ÙŠØ§Øª SLA Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡</h4>
                    <div class="chart-container chart-small">
                        <canvas id="chart-sla-impact"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Render SLA impact chart
            renderSLAImpactChart();
        }
        
        // ============================================
        // Helper: Validate Response (Filter Garbage)
        // ============================================
        function isValidResponse(value, minLength = 3) {
            if (!value) return false;
            
            const cleaned = value.trim().toLowerCase();
            
            // Empty or too short
            if (cleaned.length < minLength) return false;
            
            // Only dots
            if (/^\.+$/.test(cleaned)) return false;
            
            // Only commas
            if (/^ØŒ+$/.test(cleaned)) return false;
            
            // Common garbage responses
            const garbageWords = [
                'Ù„Ø§ Ø£Ø¹Ø±Ù',
                'Ù„Ø§ Ø§Ø¹Ø±Ù',
                'Ù…Ø´ Ø¹Ø§Ø±Ù',
                'Ù…Ø¹Ø±ÙØ´',
                'Ù„Ø§ Ø§Ø¹Ù„Ù…',
                'Ù„Ø§ Ø£Ø¹Ù„Ù…',
                'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                'Ù„Ø§ÙŠÙˆØ¬Ø¯',
                'ØªÙ…',
                'Ù„Ø§',
                'Ù„Ø£',
                'Ù…ÙÙŠØ´',
                'Ù…Ø§ÙÙŠØ´',
                '...',
                '..',
                'ØŒØŒ',
                'ØŒØŒØŒ'
            ];
            
            if (garbageWords.includes(cleaned)) return false;
            
            // Single character (except Arabic numbers)
            if (cleaned.length === 1 && !/[Ù -Ù©0-9]/.test(cleaned)) return false;
            
            return true;
        }

        // ============================================
        // Render Departments Tab
        // ============================================
        function renderDepartmentsTab() {
            const container = document.getElementById('tab-departments');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ¢</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            // Analyze by department
            const depts = {};
            allResponses.forEach(r => {
                const dept = r.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                if (!depts[dept]) {
                    depts[dept] = {
                        count: 0,
                        roleClarity: [],
                        cooperation: [],
                        readiness: [],
                        expectedImpact: []
                    };
                }
                depts[dept].count++;
                if (r.role_clarity) depts[dept].roleClarity.push(parseFloat(r.role_clarity));
                if (r.cooperation_quality) depts[dept].cooperation.push(parseFloat(r.cooperation_quality));
                if (r.readiness_new_procedures) depts[dept].readiness.push(parseFloat(r.readiness_new_procedures));
                if (r.expected_impact) depts[dept].expectedImpact.push(parseFloat(r.expected_impact));
            });
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">ğŸ¢ ØªØ­Ù„ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                <div class="list-container">
            `;
            
            Object.entries(depts)
                .sort((a, b) => b[1].count - a[1].count)
                .forEach(([dept, data]) => {
                    const avgClarity = data.roleClarity.length > 0 
                        ? (data.roleClarity.reduce((a, b) => a + b, 0) / data.roleClarity.length).toFixed(1)
                        : 'N/A';
                    const avgCoop = data.cooperation.length > 0
                        ? (data.cooperation.reduce((a, b) => a + b, 0) / data.cooperation.length).toFixed(1)
                        : 'N/A';
                    const avgReadiness = data.readiness.length > 0
                        ? (data.readiness.reduce((a, b) => a + b, 0) / data.readiness.length).toFixed(1)
                        : 'N/A';
                    const avgImpact = data.expectedImpact.length > 0
                        ? (data.expectedImpact.reduce((a, b) => a + b, 0) / data.expectedImpact.length).toFixed(1)
                        : 'N/A';
                    
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">${dept}</div>
                                <div class="list-item-badge">${data.count} Ù…Ø´Ø§Ø±Ùƒ</div>
                            </div>
                            <div class="list-item-meta">
                                <span>â­ ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ±: ${avgClarity}/10</span>
                                <span>ğŸ¤ Ø§Ù„ØªØ¹Ø§ÙˆÙ†: ${avgCoop}/10</span>
                                <span>ğŸ”¥ Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯: ${avgReadiness}/10</span>
                                <span>ğŸ¯ Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: ${avgImpact}/10</span>
                            </div>
                        </div>
                    `;
                });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        // ============================================
        // Render Stories Tab
        // ============================================
        function renderStoriesTab() {
            const container = document.getElementById('tab-stories');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“–</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            // Collect all stories
            const stories = {
                bottlenecks: [],
                unclearProcedures: [],
                brokeProcedures: [],
                positiveCoordination: [],
                worstBottlenecks: []
            };
            
            allResponses.forEach(r => {
                if (r.bottleneck_story && r.bottleneck_story.trim().length > 20) {
                    stories.bottlenecks.push({
                        content: r.bottleneck_story,
                        dept: r.department,
                        exp: r.experience
                    });
                }
                if (r.unclear_procedure_story && r.unclear_procedure_story.trim().length > 20) {
                    stories.unclearProcedures.push({
                        content: r.unclear_procedure_story,
                        dept: r.department,
                        exp: r.experience
                    });
                }
                if (r.broke_procedure_details && r.broke_procedure_details.trim().length > 20) {
                    stories.brokeProcedures.push({
                        content: r.broke_procedure_details,
                        dept: r.department,
                        exp: r.experience
                    });
                }
                if (r.positive_coordination_story && r.positive_coordination_story.trim().length > 20) {
                    stories.positiveCoordination.push({
                        content: r.positive_coordination_story,
                        dept: r.department,
                        exp: r.experience
                    });
                }
                if (r.worst_bottleneck && r.worst_bottleneck.trim().length > 20) {
                    stories.worstBottlenecks.push({
                        content: r.worst_bottleneck,
                        dept: r.department,
                        exp: r.experience
                    });
                }
            });
            
            let html = `
                <h3 style="margin-bottom: 20px; color: var(--dark);">ğŸ“– Ø§Ù„Ù‚ØµØµ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ© Ù…Ù† Ø§Ù„Ù…ÙŠØ¯Ø§Ù†</h3>
            `;
            
            // Bottleneck stories
            if (stories.bottlenecks.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>ğŸš§</span>
                            Ù‚ØµØµ Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª ÙˆØªØ¹Ø·Ù„ (${stories.bottlenecks.length} Ù‚ØµØ©)
                        </h4>
                        <div class="list-container">
                `;
                stories.bottlenecks.forEach((s, i) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© #${i + 1}</div>
                                <div class="list-item-badge">${s.dept}</div>
                            </div>
                            <div class="list-item-content">${s.content}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.exp}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Unclear procedures
            if (stories.unclearProcedures.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>â“</span>
                            Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø© (${stories.unclearProcedures.length} Ù‚ØµØ©)
                        </h4>
                        <div class="list-container">
                `;
                stories.unclearProcedures.forEach((s, i) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© #${i + 1}</div>
                                <div class="list-item-badge">${s.dept}</div>
                            </div>
                            <div class="list-item-content">${s.content}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.exp}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Broke procedures
            if (stories.brokeProcedures.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>âš ï¸</span>
                            Ù…ÙˆØ§Ù‚Ù ÙƒØ³Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª (${stories.brokeProcedures.length} Ù‚ØµØ©)
                        </h4>
                        <div class="list-container">
                `;
                stories.brokeProcedures.forEach((s, i) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© #${i + 1}</div>
                                <div class="list-item-badge">${s.dept}</div>
                            </div>
                            <div class="list-item-content">${s.content}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.exp}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Positive coordination
            if (stories.positiveCoordination.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>âœ…</span>
                            Ù‚ØµØµ Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ (${stories.positiveCoordination.length} Ù‚ØµØ©)
                        </h4>
                        <div class="list-container">
                `;
                stories.positiveCoordination.forEach((s, i) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© Ù†Ø¬Ø§Ø­ #${i + 1}</div>
                                <div class="list-item-badge">${s.dept}</div>
                            </div>
                            <div class="list-item-content">${s.content}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.exp}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            // Worst bottlenecks
            if (stories.worstBottlenecks.length > 0) {
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ”¥</span>
                            Ø£Ø³ÙˆØ£ Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª ÙÙŠ Ø¢Ø®Ø± 6 Ø´Ù‡ÙˆØ± (${stories.worstBottlenecks.length} Ù‚ØµØ©)
                        </h4>
                        <div class="list-container">
                `;
                stories.worstBottlenecks.forEach((s, i) => {
                    html += `
                        <div class="list-item">
                            <div class="list-item-header">
                                <div class="list-item-title">Ù‚ØµØ© #${i + 1}</div>
                                <div class="list-item-badge">${s.dept}</div>
                            </div>
                            <div class="list-item-content">${s.content}</div>
                            <div class="list-item-meta">
                                <span>ğŸ‘¤ ${s.exp}</span>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            }
            
            if (stories.bottlenecks.length === 0 && 
                stories.unclearProcedures.length === 0 && 
                stories.brokeProcedures.length === 0 && 
                stories.positiveCoordination.length === 0 &&
                stories.worstBottlenecks.length === 0) {
                html += `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“–</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ØµØµ Ù…ÙˆØ«Ù‚Ø©</div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // ============================================
        // Render Responses Tab
        // ============================================
        function renderResponsesTab() {
            const container = document.getElementById('tab-responses');
            
            if (allResponses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div class="empty-state-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--dark); margin: 0;">ğŸ“ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© (${allResponses.length})</h3>
                    <button class="btn btn-secondary" onclick="refreshData()">
                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                    </button>
                </div>
                
                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label class="filter-label">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</label>
                        <select class="filter-select" id="filter-dept" onchange="filterResponses()">
                            <option value="">Ø§Ù„ÙƒÙ„</option>
                            ${[...new Set(allResponses.map(r => r.department))].map(d => 
                                `<option value="${d}">${d}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="search-box">
                        <input type="text" class="search-input" id="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯..." onkeyup="searchResponses()">
                        <span class="search-icon">ğŸ”</span>
                    </div>
                </div>
                
                <div id="responses-list" class="list-container">
            `;
            
            allResponses.forEach((r, index) => {
                html += createResponseCard(r, index);
            });
            
            html += `</div>`;
            
            container.innerHTML = html;
        }
        
        // ============================================
        // Create Beautiful Response Card
        // ============================================
        function createResponseCard(response, index) {
            return `
                <div class="response-card" data-dept="${response.department}" data-id="${response.id}">
                    <!-- Card Header -->
                    <div class="response-card-header">
                        <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                            <div class="response-number">
                                #${index + 1}
                            </div>
                            <div>
                                <div class="response-title">${response.department}</div>
                                <div class="response-meta">
                                    <span>ğŸ‘¤ ${response.experience}</span>
                                    <span>â€¢</span>
                                    <span>ğŸ’¼ ${response.work_nature}</span>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-icon btn-icon-danger" onclick="deleteResponse('${response.id}')" title="Ø­Ø°Ù Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©">
                                ğŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="response-quick-stats">
                        <div class="quick-stat">
                            <div class="quick-stat-icon">â­</div>
                            <div class="quick-stat-content">
                                <div class="quick-stat-label">ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ±</div>
                                <div class="quick-stat-value">${response.role_clarity}/10</div>
                            </div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">ğŸ¤</div>
                            <div class="quick-stat-content">
                                <div class="quick-stat-label">Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ†</div>
                                <div class="quick-stat-value">${response.cooperation_quality}/10</div>
                            </div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">ğŸ”¥</div>
                            <div class="quick-stat-content">
                                <div class="quick-stat-label">Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯</div>
                                <div class="quick-stat-value">${response.readiness_new_procedures}/10</div>
                            </div>
                        </div>
                        <div class="quick-stat">
                            <div class="quick-stat-icon">ğŸ¯</div>
                            <div class="quick-stat-content">
                                <div class="quick-stat-label">Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</div>
                                <div class="quick-stat-value">${response.expected_impact}/10</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Details Toggle -->
                    <details class="response-details">
                        <summary class="response-summary">
                            ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
                        </summary>
                        
                        <div class="response-details-content">
                            ${formatResponseDetails(response)}
                        </div>
                    </details>
                </div>
            `;
        }
        
        // ============================================
        // Format Response Details Beautifully
        // ============================================
        function formatResponseDetails(r) {
            let html = '';
            
            // Section 1: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="detail-icon">ğŸ‘¤</span>
                        Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ
                    </div>
                    <div class="detail-grid">
                        ${createDetailItem('Ø§Ù„Ù‚Ø³Ù…/Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', r.department)}
                        ${createDetailItem('Ø³Ù†ÙˆØ§Øª Ø§Ù„Ø®Ø¨Ø±Ø©', r.experience)}
                        ${createDetailItem('Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„', r.work_nature)}
                        ${createDetailItem('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡Ø§', r.departments_count)}
                    </div>
                </div>
            `;
            
            // Section 2: Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="detail-icon">ğŸ“Š</span>
                        Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª (Ù…Ù† 1 Ø¥Ù„Ù‰ 10)
                    </div>
                    <div class="detail-grid">
                        ${createRatingItem('ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ± ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠØ§Øª', r.role_clarity)}
                        ${createRatingItem('Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø¨ÙŠÙ† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', r.cooperation_quality)}
                        ${createRatingItem('Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©', r.readiness_new_procedures)}
                        ${createRatingItem('Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ÙˆØ±Ø´Ø©', r.expected_impact)}
                    </div>
                </div>
            `;
            
            // Section 3: ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="detail-icon">ğŸ“‹</span>
                        ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                    </div>
                    <div class="detail-list">
                        ${createDetailItem('Ù…ØµØ§Ø¯Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª', Array.isArray(r.instruction_sources) ? r.instruction_sources.join('ØŒ ') : r.instruction_sources)}
                        ${createDetailItem('Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©', r.documented_procedures)}
                        ${createDetailItem('Ù…Ø¯Ø© ØªØ¯Ø±ÙŠØ¨ Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯', r.training_duration)}
                        ${createDetailItem('ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø©', r.duplicate_work)}
                        ${createDetailItem('Ù…Ø¯Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆØ§ÙÙ‚Ø§Øª', r.approval_duration)}
                        ${createDetailItem('Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª', r.non_compliance_reason)}
                    </div>
                </div>
            `;
            
            // Section 4: Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª
            const hasBottleneckData = (r.time_wasters && r.time_wasters.length > 0) || 
                                     (r.slow_department && r.slow_department !== 'Ø£ÙØ¶Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©') ||
                                     (r.bottleneck_story && r.bottleneck_story.trim() !== '.' && r.bottleneck_story.trim() !== '');
            
            if (hasBottleneckData) {
                html += `
                    <div class="detail-section detail-section-warning">
                        <div class="detail-section-title">
                            <span class="detail-icon">ğŸš§</span>
                            Ø§Ù„Ø§Ø®ØªÙ†Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¹ÙˆØ§Ø¦Ù‚
                        </div>
                        <div class="detail-list">
                            ${r.time_wasters && r.time_wasters.length > 0 ? createDetailItem('Ø£ÙƒØ«Ø± Ù…Ø§ ÙŠØ¶ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øª', Array.isArray(r.time_wasters) ? r.time_wasters.join('ØŒ ') : r.time_wasters) : ''}
                            ${r.slow_department && r.slow_department !== 'Ø£ÙØ¶Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©' ? createDetailItem('Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø¨Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©', r.slow_department) : ''}
                            ${r.improvement_if_faster ? createDetailItem('Ø§Ù„ØªØ­Ø³Ù† Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ùˆ ÙƒØ§Ù† Ø£Ø³Ø±Ø¹', r.improvement_if_faster) : ''}
                            ${r.longest_wait ? createDetailItem('Ø£Ø·ÙˆÙ„ Ù…Ø¯Ø© Ø§Ù†ØªØ¸Ø§Ø±', r.longest_wait) : ''}
                            ${r.delay_main_reason ? createDetailItem('Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„ØªØ£Ø®ÙŠØ±', r.delay_main_reason) : ''}
                            ${r.bottleneck_story && r.bottleneck_story.trim() !== '.' && r.bottleneck_story.trim() !== '' ? createTextItem('Ù‚ØµØ© Ø§Ø®ØªÙ†Ø§Ù‚ Ø­Ù‚ÙŠÙ‚ÙŠØ©', r.bottleneck_story) : ''}
                            ${r.unnecessary_step_example && r.unnecessary_step_example.trim() !== '' ? createTextItem('Ø®Ø·ÙˆØ© Ø²Ø§Ø¦Ø¯Ø© ØºÙŠØ± Ù…ÙÙŠØ¯Ø©', r.unnecessary_step_example) : ''}
                        </div>
                    </div>
                `;
            }
            
            // Section 5: Ø§Ù„ØªØ¹Ø§ÙˆÙ† ÙˆØ§Ù„Ù€ SLAs
            html += `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span class="detail-icon">ğŸ¤</span>
                        Ø§Ù„ØªØ¹Ø§ÙˆÙ† ÙˆØ§Ù„Ù€ SLAs
                    </div>
                    <div class="detail-list">
                        ${createDetailItem('ÙˆØ¬ÙˆØ¯ Ø§ØªÙØ§Ù‚ÙŠØ§Øª SLA Ø­Ø§Ù„ÙŠØ§Ù‹', r.sla_existence)}
                        ${createDetailItem('ØªÙˆÙ‚Ø¹ Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø±Ø¯', r.response_expectation)}
                        ${createDetailItem('Ø£ÙƒØ«Ø± Ø³Ù„ÙˆÙƒ Ø³Ù„Ø¨ÙŠ', r.negative_behavior)}
                        ${createDetailItem('Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨', r.one_change)}
                        ${createDetailItem('ØªØ£Ø«ÙŠØ± SLAs Ø§Ù„Ù…ØªÙˆÙ‚Ø¹', r.sla_impact)}
                    </div>
                </div>
            `;
            
            // Section 6: Ø§Ù„Ù‚ØµØµ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ù
            const hasStories = (r.unclear_procedure_story && r.unclear_procedure_story.trim() !== '.' && r.unclear_procedure_story.trim() !== '') ||
                              (r.broke_procedure === 'Ù†Ø¹Ù…' && r.broke_procedure_details) ||
                              (r.positive_coordination_story && r.positive_coordination_story.trim() !== '.' && r.positive_coordination_story.trim() !== '') ||
                              (r.worst_bottleneck && r.worst_bottleneck.trim() !== '.' && r.worst_bottleneck.trim() !== '');
            
            if (hasStories) {
                html += `
                    <div class="detail-section detail-section-info">
                        <div class="detail-section-title">
                            <span class="detail-icon">ğŸ“–</span>
                            Ø§Ù„Ù‚ØµØµ ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ù Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©
                        </div>
                        <div class="detail-list">
                            ${r.unclear_procedure_story && r.unclear_procedure_story.trim() !== '.' && r.unclear_procedure_story.trim() !== '' ? createTextItem('Ù…ÙˆÙ‚Ù: Ø¥Ø¬Ø±Ø§Ø¡ ØºÙŠØ± ÙˆØ§Ø¶Ø­', r.unclear_procedure_story) : ''}
                            ${r.broke_procedure === 'Ù†Ø¹Ù…' && r.broke_procedure_details ? createTextItem('Ù…ÙˆÙ‚Ù: ÙƒØ³Ø± Ø¥Ø¬Ø±Ø§Ø¡', r.broke_procedure_details) : ''}
                            ${r.positive_coordination_story && r.positive_coordination_story.trim() !== '.' && r.positive_coordination_story.trim() !== '' ? createTextItem('Ù…ÙˆÙ‚Ù Ø¥ÙŠØ¬Ø§Ø¨ÙŠ: ØªÙ†Ø³ÙŠÙ‚ Ù…Ù…ØªØ§Ø²', r.positive_coordination_story) : ''}
                            ${r.worst_bottleneck && r.worst_bottleneck.trim() !== '.' && r.worst_bottleneck.trim() !== '' ? createTextItem('Ø£Ø³ÙˆØ£ Ø§Ø®ØªÙ†Ø§Ù‚ (6 Ø´Ù‡ÙˆØ±)', r.worst_bottleneck) : ''}
                            ${r.conflict_frequency ? createDetailItem('ØªØ¶Ø§Ø±Ø¨ Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙ…ÙˆÙŠÙ„', r.conflict_frequency) : ''}
                        </div>
                    </div>
                `;
            }
            
            // Section 7: Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª
            html += `
                <div class="detail-section detail-section-success">
                    <div class="detail-section-title">
                        <span class="detail-icon">ğŸ¯</span>
                        Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù…Ù‚ØªØ±Ø­Ø§Øª
                    </div>
                    <div class="detail-list">
                        <div class="detail-item-special">
                            <strong>âœ¨ Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ù‡ Ø¹ØµØ§ Ø³Ø­Ø±ÙŠØ© - 3 Ø­Ø§Ø¬Ø§Øª ÙŠØµÙ„Ø­Ù‡Ø§:</strong>
                            ${r.magic_fix_1 && r.magic_fix_1.trim() !== '.' && r.magic_fix_1.trim() !== '' ? `<div class="priority-badge">1ï¸âƒ£ ${r.magic_fix_1}</div>` : ''}
                            ${r.magic_fix_2 && r.magic_fix_2.trim() !== '.' && r.magic_fix_2.trim() !== '' ? `<div class="priority-badge">2ï¸âƒ£ ${r.magic_fix_2}</div>` : ''}
                            ${r.magic_fix_3 && r.magic_fix_3.trim() !== '.' && r.magic_fix_3.trim() !== '' ? `<div class="priority-badge">3ï¸âƒ£ ${r.magic_fix_3}</div>` : ''}
                        </div>
                        
                        <div class="detail-item-special">
                            <strong>ğŸ“‹ Ø£Ù‡Ù… 3 Ø¹Ù…Ù„ÙŠØ§Øª ØªØ­ØªØ§Ø¬ SOPs:</strong>
                            ${r.sop_priority_1 && r.sop_priority_1.trim() !== '.' && r.sop_priority_1.trim() !== '' ? `<div class="priority-badge">1ï¸âƒ£ ${r.sop_priority_1}</div>` : ''}
                            ${r.sop_priority_2 && r.sop_priority_2.trim() !== '.' && r.sop_priority_2.trim() !== '' ? `<div class="priority-badge">2ï¸âƒ£ ${r.sop_priority_2}</div>` : ''}
                            ${r.sop_priority_3 && r.sop_priority_3.trim() !== '.' && r.sop_priority_3.trim() !== '' ? `<div class="priority-badge">3ï¸âƒ£ ${r.sop_priority_3}</div>` : ''}
                        </div>
                        
                        <div class="detail-item-special">
                            <strong>â±ï¸ Ø£Ù‡Ù… 3 Ø¥Ø¯Ø§Ø±Ø§Øª ØªØ­ØªØ§Ø¬ SLAs:</strong>
                            ${r.sla_priority_1 && r.sla_priority_1.trim() !== '.' && r.sla_priority_1.trim() !== '' ? `<div class="priority-badge">1ï¸âƒ£ ${r.sla_priority_1}</div>` : ''}
                            ${r.sla_priority_2 && r.sla_priority_2.trim() !== '.' && r.sla_priority_2.trim() !== '' ? `<div class="priority-badge">2ï¸âƒ£ ${r.sla_priority_2}</div>` : ''}
                            ${r.sla_priority_3 && r.sla_priority_3.trim() !== '.' && r.sla_priority_3.trim() !== '' ? `<div class="priority-badge">3ï¸âƒ£ ${r.sla_priority_3}</div>` : ''}
                        </div>
                        
                        ${r.final_message && r.final_message.trim() !== '.' && r.final_message.trim() !== '' ? createTextItem('ğŸ’¬ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø¯ÙŠØ±', r.final_message) : ''}
                    </div>
                </div>
            `;
            
            return html;
        }
        
        // ============================================
        // Helper: Create Detail Item
        // ============================================
        function createDetailItem(label, value) {
            if (!value || value === '' || value === '.' || value === 'undefined') return '';
            return `
                <div class="detail-item">
                    <span class="detail-label">${label}:</span>
                    <span class="detail-value">${value}</span>
                </div>
            `;
        }
        
        // ============================================
        // Helper: Create Text Item (for long text)
        // ============================================
        function createTextItem(label, value) {
            if (!value || value === '' || value === '.' || value === 'undefined') return '';
            return `
                <div class="detail-item-text">
                    <div class="detail-label-text">${label}:</div>
                    <div class="detail-value-text">${value}</div>
                </div>
            `;
        }
        
        // ============================================
        // Helper: Create Rating Item
        // ============================================
        function createRatingItem(label, value) {
            if (!value) return '';
            const percentage = (parseFloat(value) / 10) * 100;
            const color = percentage >= 70 ? '#28a745' : percentage >= 50 ? '#ffc107' : '#dc3545';
            
            return `
                <div class="detail-rating">
                    <div class="detail-rating-header">
                        <span class="detail-label">${label}</span>
                        <span class="detail-rating-value" style="color: ${color};">${value}/10</span>
                    </div>
                    <div class="detail-rating-bar">
                        <div class="detail-rating-fill" style="width: ${percentage}%; background: ${color};"></div>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // Chart Rendering Functions
        // ============================================
        
        function renderDepartmentsChart() {
            const ctx = document.getElementById('chart-departments');
            if (!ctx) return;
            
            const deptCounts = countByField('department');
            const labels = Object.keys(deptCounts);
            const data = Object.values(deptCounts);
            
            if (charts['departments']) charts['departments'].destroy();
            
            charts['departments'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderExperienceChart() {
            const ctx = document.getElementById('chart-experience');
            if (!ctx) return;
            
            const expCounts = countByField('experience');
            const expOrder = [
                'Ø£Ù‚Ù„ Ù…Ù† 6 Ø´Ù‡ÙˆØ±',
                '6 Ø´Ù‡ÙˆØ± - Ø³Ù†Ø©',
                '1-3 Ø³Ù†ÙˆØ§Øª',
                '3-5 Ø³Ù†ÙˆØ§Øª',
                'Ø£ÙƒØ«Ø± Ù…Ù† 5 Ø³Ù†ÙˆØ§Øª'
            ];
            const labels = expOrder.filter(e => expCounts[e]);
            const data = labels.map(l => expCounts[l]);
            
            if (charts['experience']) charts['experience'].destroy();
            
            charts['experience'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderRoleClarityChart() {
            const ctx = document.getElementById('chart-role-clarity');
            if (!ctx) return;
            
            const distribution = getScaleDistribution('role_clarity');
            
            if (charts['roleClarity']) charts['roleClarity'].destroy();
            
            charts['roleClarity'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: distribution,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgba(40, 167, 69, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderCooperationChart() {
            const ctx = document.getElementById('chart-cooperation');
            if (!ctx) return;
            
            const distribution = getScaleDistribution('cooperation_quality');
            
            if (charts['cooperation']) charts['cooperation'].destroy();
            
            charts['cooperation'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: distribution,
                        backgroundColor: 'rgba(23, 162, 184, 0.8)',
                        borderColor: 'rgba(23, 162, 184, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderDocumentedChart() {
            const ctx = document.getElementById('chart-documented');
            if (!ctx) return;
            
            const docCounts = countByField('documented_procedures');
            const order = ['Ø£Ù‚Ù„ Ù…Ù† 25%', '25-50%', '50-75%', '75%+'];
            const labels = order.filter(o => docCounts[o]);
            const data = labels.map(l => docCounts[l]);
            
            if (charts['documented']) charts['documented'].destroy();
            
            charts['documented'] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#007bff'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        function renderTrainingChart() {
            const ctx = document.getElementById('chart-training');
            if (!ctx) return;
            
            const trainCounts = countByField('training_duration');
            const order = [
                'Ø£Ù‚Ù„ Ù…Ù† Ø£Ø³Ø¨ÙˆØ¹',
                'Ø£Ø³Ø¨ÙˆØ¹ - Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ†',
                'Ø´Ù‡Ø±',
                '2-3 Ø´Ù‡ÙˆØ±',
                'Ø£ÙƒØ«Ø± Ù…Ù† 3 Ø´Ù‡ÙˆØ±'
            ];
            const labels = order.filter(o => trainCounts[o]);
            const data = labels.map(l => trainCounts[l]);
            
            if (charts['training']) charts['training'].destroy();
            
            charts['training'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: data,
                        backgroundColor: 'rgba(255, 193, 7, 0.8)',
                        borderColor: 'rgba(255, 193, 7, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderExpectedImpactChart() {
            const ctx = document.getElementById('chart-expected-impact');
            if (!ctx) return;
            
            const distribution = getScaleDistribution('expected_impact');
            
            if (charts['expectedImpact']) charts['expectedImpact'].destroy();
            
            charts['expectedImpact'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10'],
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: distribution,
                        backgroundColor: 'rgba(118, 75, 162, 0.2)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderDelayReasonsChart(sortedDelayReasons) {
            const ctx = document.getElementById('chart-delay-reasons');
            if (!ctx) return;
            
            const labels = sortedDelayReasons.map(r => r[0]);
            const data = sortedDelayReasons.map(r => r[1]);
            
            if (charts['delayReasons']) charts['delayReasons'].destroy();
            
            charts['delayReasons'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†',
                        data: data,
                        backgroundColor: 'rgba(220, 53, 69, 0.8)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
        }
        
        function renderSLAImpactChart() {
            const ctx = document.getElementById('chart-sla-impact');
            if (!ctx) return;
            
            const slaCounts = countByField('sla_impact');
            const order = [
                'Ù†Ø¹Ù…ØŒ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ± Ø¬Ø¯Ù‹Ø§',
                'Ù†Ø¹Ù…ØŒ Ø¨Ø´ÙƒÙ„ Ù…Ù„Ø­ÙˆØ¸',
                'Ù†Ø¹Ù…ØŒ Ù„ÙƒÙ† Ø¨Ø³ÙŠØ·',
                'Ù„Ø§ØŒ Ù„Ù† ÙŠØªØºÙŠØ± Ø´ÙŠØ¡'
            ];
            const labels = order.filter(o => slaCounts[o]);
            const data = labels.map(l => slaCounts[l]);
            
            if (charts['slaImpact']) charts['slaImpact'].destroy();
            
            charts['slaImpact'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        // ============================================
        // Helper Functions
        // ============================================
        
        function calculateAverage(field) {
            const values = allResponses
                .map(r => parseFloat(r[field]))
                .filter(v => !isNaN(v));
            
            if (values.length === 0) return 0;
            return values.reduce((a, b) => a + b, 0) / values.length;
        }
        
        function countByField(field) {
            const counts = {};
            allResponses.forEach(r => {
                const value = r[field];
                if (value) {
                    counts[value] = (counts[value] || 0) + 1;
                }
            });
            return counts;
        }
        
        function getScaleDistribution(field) {
            const distribution = Array(10).fill(0);
            allResponses.forEach(r => {
                const value = parseInt(r[field]);
                if (value >= 1 && value <= 10) {
                    distribution[value - 1]++;
                }
            });
            return distribution;
        }
        
        function formatFieldName(key) {
            const names = {
                'department': 'Ø§Ù„Ù‚Ø³Ù…',
                'experience': 'Ø§Ù„Ø®Ø¨Ø±Ø©',
                'work_nature': 'Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„',
                'role_clarity': 'ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ±',
                'cooperation_quality': 'Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ†',
                'expected_impact': 'Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹',
                'readiness_new_procedures': 'Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©',
                'documented_procedures': 'Ù†Ø³Ø¨Ø© Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ÙˆØ«Ù‚Ø©',
                'training_duration': 'Ù…Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨',
                'bottleneck_story': 'Ù‚ØµØ© Ø§Ø®ØªÙ†Ø§Ù‚',
                'magic_fix_1': 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£ÙˆÙ„',
                'magic_fix_2': 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø«Ø§Ù†ÙŠ',
                'magic_fix_3': 'Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø«Ø§Ù„Ø«',
                'sop_priority_1': 'Ø£ÙˆÙ„ÙˆÙŠØ© SOP Ø§Ù„Ø£ÙˆÙ„Ù‰',
                'sla_priority_1': 'Ø£ÙˆÙ„ÙˆÙŠØ© SLA Ø§Ù„Ø£ÙˆÙ„Ù‰'
            };
            return names[key] || key;
        }
        
        // ============================================
        // Tab Switching
        // ============================================
        function switchTab(tabName) {
            // Remove active from all tabs and contents
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active to clicked tab
            event.target.classList.add('active');
            
            // Show corresponding content
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        // ============================================
        // Filter and Search
        // ============================================
        function filterResponses() {
            const deptFilter = document.getElementById('filter-dept').value;
            const items = document.querySelectorAll('#responses-list .list-item');
            
            items.forEach(item => {
                const dept = item.getAttribute('data-dept');
                if (deptFilter === '' || dept === deptFilter) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function searchResponses() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('#responses-list .list-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // ============================================
        // Refresh Data
        // ============================================
        async function refreshData() {
            showLoading();
            await loadAllData();
            hideLoading();
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }
        
        // ============================================
        // AI Analysis
        // ============================================
       // ============================================
        // AI Analysis (with Firebase Cache)
        // ============================================
        async function triggerAIAnalysis() {
            if (allResponses.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„');
                return;
            }
            
            const aiContent = document.getElementById('ai-content');
            aiContent.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-spinner"></div>
                    <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ... Ù‡Ø°Ø§ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ 30-60 Ø«Ø§Ù†ÙŠØ©</span>
                </div>
            `;
            
            try {
                console.log('ğŸ” Checking for existing analysis in Firebase...');
                
                // Check if analysis already exists in Firebase
                const existingAnalysis = await checkExistingAnalysis();
                
                if (existingAnalysis) {
                    console.log('âœ… Found existing analysis in Firebase!');
                    displayAnalysis(existingAnalysis.fullText, true);
                    return;
                }
                
                console.log('ğŸš€ No existing analysis found, calling AI API...');
                console.log('ğŸ“Š Total responses:', allResponses.length);
                
                // Call API
                const response = await fetch('/api/analyze-internal-procedures-survey', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'analyze',
                        responses: allResponses
                    })
                });
                
                console.log('ğŸ“¡ Response status:', response.status);
                
                // Get response text
                const responseText = await response.text();
                console.log('ğŸ“„ Response length:', responseText.length);
                console.log('ğŸ“„ Response preview:', responseText.substring(0, 300));
                
                if (!response.ok) {
                    let errorMessage = 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„';
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.message || errorData.error || errorMessage;
                        console.error('âŒ Error details:', errorData);
                    } catch (e) {
                        console.error('âŒ Raw error:', responseText);
                    }
                    throw new Error(errorMessage);
                }
                
                // Parse response
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('âœ… Response parsed successfully');
                } catch (parseError) {
                    console.error('âŒ Parse error:', parseError);
                    throw new Error('ÙØ´Ù„ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…');
                }
                
                if (!result.analysis) {
                    console.error('âŒ No analysis in response');
                    throw new Error('Ø§Ù„Ø±Ø¯ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„');
                }
                
                console.log('âœ… Analysis received, length:', result.analysis.length);
                
                // Display analysis
                displayAnalysis(result.analysis, false);
                
            } catch (error) {
                console.error('âŒ AI Analysis Error:', error);
                console.error('âŒ Error stack:', error.stack);
                
                aiContent.innerHTML = `
                    <div style="color: var(--danger); padding: 20px; background: #fff5f5; border-radius: 10px; border-right: 5px solid var(--danger);">
                        <h4 style="margin-bottom: 15px;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù„ÙŠÙ„</h4>
                        <p style="margin-bottom: 10px;"><strong>Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</strong> ${error.message}</p>
                        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">
                            Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙØªØ­ Developer Console (F12) ÙˆØ£Ø®Ø° screenshot Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡.
                        </p>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-secondary" onclick="loadExistingAnalysis()">
                                ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase
                            </button>
                            <button class="btn btn-secondary" onclick="triggerAIAnalysis()">
                                ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // ============================================
        // Check if Analysis Already Exists
        // ============================================
        async function checkExistingAnalysis() {
            try {
                const snapshot = await db.collection('internal-procedures-analysis')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    return null;
                }
                
                const doc = snapshot.docs[0];
                const data = doc.data();
                
                // Check if it's recent (within last 24 hours)
                const docTime = data.timestamp?.toDate();
                if (docTime) {
                    const hoursSince = (Date.now() - docTime.getTime()) / (1000 * 60 * 60);
                    if (hoursSince < 24) {
                        console.log(`âœ… Found analysis from ${hoursSince.toFixed(1)} hours ago`);
                        return data;
                    }
                }
                
                return null;
            } catch (error) {
                console.error('Error checking existing analysis:', error);
                return null;
            }
        }
        
        // ============================================
        // Load Existing Analysis from Firebase
        // ============================================
        async function loadExistingAnalysis() {
            const aiContent = document.getElementById('ai-content');
            aiContent.innerHTML = `
                <div class="ai-loading">
                    <div class="ai-spinner"></div>
                    <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Firebase...</span>
                </div>
            `;
            
            try {
                const snapshot = await db.collection('internal-procedures-analysis')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    aiContent.innerHTML = `
                        <div style="color: var(--warning); padding: 20px;">
                            âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ­Ù„ÙŠÙ„ Ù…Ø­ÙÙˆØ¸ ÙÙŠ Firebase
                        </div>
                    `;
                    return;
                }
                
                const doc = snapshot.docs[0];
                const data = doc.data();
                
                if (data.fullText) {
                    displayAnalysis(data.fullText, true);
                } else {
                    throw new Error('Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø§Ù„Ù†Øµ ÙØ§Ø±Øº');
                }
                
            } catch (error) {
                console.error('Error loading analysis:', error);
                aiContent.innerHTML = `
                    <div style="color: var(--danger); padding: 20px;">
                        âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Firebase: ${error.message}
                    </div>
                `;
            }
        }
        
        // ============================================
        // Display Analysis
        // ============================================
        function displayAnalysis(analysisText, fromCache) {
            const aiContent = document.getElementById('ai-content');
            
            // Format the text
            const formattedText = formatAnalysisText(analysisText);
            
            aiContent.innerHTML = `
                ${fromCache ? `
                    <div style="background: #e8f5e9; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; border-right: 5px solid #4caf50;">
                        <strong>âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù…Ù† Firebase</strong>
                        <span style="font-size: 13px; color: #666; margin-right: 10px;">(Ù„Ù… ÙŠØªÙ… Ø³Ø­Ø¨ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯)</span>
                    </div>
                ` : `
                    <div style="background: #e3f2fd; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; border-right: 5px solid #2196f3;">
                        <strong>ğŸ†• ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</strong>
                        <span style="font-size: 13px; color: #666; margin-right: 10px;">(ØªÙ… Ø§Ù„Ø­ÙØ¸ ÙÙŠ Firebase)</span>
                    </div>
                `}
                <div style="line-height: 1.9; white-space: pre-wrap; font-size: 15px;">
                    ${formattedText}
                </div>
            `;
            
            console.log('âœ… Analysis displayed successfully');
        }
        
        // ============================================
        // Format Analysis Text
        // ============================================
        function formatAnalysisText(text) {
            // Escape HTML
            const div = document.createElement('div');
            div.textContent = text;
            let formatted = div.innerHTML;
            
            // Add some basic formatting
            // Bold headers
            formatted = formatted.replace(/^(#+\s+.+)$/gm, '<strong>$1</strong>');
            
            // Preserve line breaks
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }

        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

      // ============================================
        // Delete Response
        // ============================================
        async function deleteResponse(responseId) {
            // Confirm deletion
            const confirmed = confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ³ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.');
            
            if (!confirmed) return;
            
            showLoading();
            
            try {
                // Delete from Firestore
                await db.collection('internal-procedures-survey').doc(responseId).delete();
                
                console.log('Response deleted:', responseId);
                
                // Reload all data
                await loadAllData();
                
                hideLoading();
                
                alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nØªÙ… ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª.');
                
            } catch (error) {
                console.error('Error deleting response:', error);
                hideLoading();
                alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            }
        }
        
        // ============================================
        // Export Data
        // ============================================
        function exportData() {
            if (allResponses.length === 0) {
                alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±');
                return;
            }
            
            // Prepare data for export
            const exportData = allResponses.map((r, index) => ({
                'Ø±Ù‚Ù… Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©': index + 1,
                'Ø§Ù„ØªØ§Ø±ÙŠØ®': r.timestamp ? new Date(r.timestamp).toLocaleString('ar-EG') : 'N/A',
                'Ø§Ù„Ù‚Ø³Ù…': r.department || '',
                'Ø§Ù„Ø®Ø¨Ø±Ø©': r.experience || '',
                'Ø·Ø¨ÙŠØ¹Ø© Ø§Ù„Ø¹Ù…Ù„': r.work_nature || '',
                'ÙˆØ¶ÙˆØ­ Ø§Ù„Ø¯ÙˆØ±': r.role_clarity || '',
                'Ø¬ÙˆØ¯Ø© Ø§Ù„ØªØ¹Ø§ÙˆÙ†': r.cooperation_quality || '',
                'Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹': r.expected_impact || '',
                'Ø§Ù„Ø§Ø³ØªØ¹Ø¯Ø§Ø¯ Ù„Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©': r.readiness_new_procedures || '',
                // Add more fields as needed
            }));
            
            // Convert to CSV
            const csv = convertToCSV(exportData);
            
            // Download
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `internal-procedures-survey-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(row => 
                headers.map(header => {
                    const value = row[header];
                    // Escape quotes and wrap in quotes if contains comma
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        return `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',')
            );
            
            return [headers.join(','), ...rows].join('\n');
        }
        
    </script>
</body>
</html>
